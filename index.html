<html>
    <head>
        <style>
            <meta http-equiv="content-type" content="text/html; charset=UTF8">
            body {
              background: #fcfcfa;
            }
             
            .stroke {
              fill: none;
              stroke: #000;
              stroke-width: 3px;
            }
             
            .fill {
              fill: #fff;
            }
             
            .graticule {
              fill: none;
              stroke: #777;
              stroke-width: .5px;
              stroke-opacity: .5;
            }
             
            .land {
              fill: #bbb;
            }
             
            .boundary {
              fill: none;
              stroke: #fff;
              stroke-width: .5px;
            }
             
            .points circle {
              fill: #fff;
              stroke-width: 1px;
            }
            
            .provider {
                stroke:blue;
                fill:none;
            }
            
            .receiver {
                stroke:red;
                fill:none;
            }
             
            .points text {
              font: 11px sans-serif;
              text-anchor: middle;
              text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
            }
             
            .route {
              fill: none;
            }
        </style>

        <script src="http://d3js.org/d3.v3.min.js"></script>
        <!--<script src="d3.geo.projection.js" charset="utf-8"></script>-->
        <script src="http://d3js.org/topojson.v1.min.js"></script>
    </head>
    <body>
        <script>
            var width = 1000, height = 570;

            var places = {
                "Canada":[-113.64258,60.10867],
                "China":[105,35],
                "Finland":[26,64],
                "Germany":[10.5,51.5],
                "India":[77,20],
                "Nepal":[84,28],
                "Vietnam":[107.83333,16.16667],
                "Asian Development Bank":[120.9822,14.6042],
                "Government of Finland":[24.93545,60.16952],
                "Swiss Agency for Development and Cooperation":[7.44744,46.94809],
                "World Bank":[-77.03637,38.89511]
            };
            
            var volumes = {
                "Canada":{volume:9707000,type:'receiver'},
                "China":{volume:1043000,type:'receiver'},
                "Finland":{volume:11316305,type:'receiver'},
                "Germany":{volume:65000,type:'receiver'},
                "India":{volume:12142076,type:'receiver'},
                "Nepal":{volume:117745931.16,type:'receiver'},
                "Vietnam":{volume:93100,type:'receiver'},
                "Asian Development Bank":{volume:33178122,type:'provider'},
                "Government of Finland":{volume:11409405,type:'provider'},
                "Swiss Agency for Development and Cooperation":{volume:2859694,type:'provider'},
                "World Bank":{volume:104665191,type:'provider'}
            }
            
            var paths = [
                {
                    type: "LineString",
                    coordinates: [
                        places.Nepal,
                        places.Canada
                    ],
                    properties: {
                        class:'receiver',
                        type:'route',
                        volume: 9707000
                    }
                },
                {
                    type: "LineString",
                    coordinates: [
                        places.Nepal,
                        places.China
                    ],
                    properties: {
                        class:'receiver',
                        type:'route',
                        volume: 1043000
                        }
                },
                {
                    type: "LineString",
                    coordinates: [
                        places.Nepal,
                        places.Finland
                    ],
                    properties: {
                        class:'receiver',
                        type:'route',
                        volume: 11316305
                        }
                },
                {
                    type: "LineString",
                    coordinates: [
                        places.Nepal,
                        places.Germany
                    ],
                    properties: {
                        class:'receiver',
                        type:'route',
                        volume: 65000
                    }
                },
                {
                    type: "LineString",
                    coordinates: [
                        places.Nepal,
                        places.India
                    ],
                    properties: {
                        class:'receiver',
                        type:'route',
                        volume: 12142076
                    }
                },     
                {
                    type: "LineString",
                    coordinates: [
                        places.Nepal,
                        places.Vietnam
                    ],
                    properties: {
                        class:'receiver',
                        type:'route',
                        volume: 93100
                    }
                },
                {
                    type: "LineString",
                    coordinates: [
                        places['Asian Development Bank'],
                        places.Nepal
                    ],
                    properties: {
                        class:'provider',
                        type:'route',
                        volume: 33178122
                    }
                },      
                {
                    type: "LineString",
                    coordinates: [
                        places['Government of Finland'],
                        places.Nepal
                    ],
                    properties: {
                        class:'provider',
                        type:'route',
                        volume: 11409405
                    }
                },  
                {
                    type: "LineString",
                    coordinates: [
                        places['Swiss Agency for Development and Cooperation'],
                        places.Nepal
                    ],
                    properties: {
                        class:'provider',
                        type:'route',
                        volume: 2859694
                    }
                },  
                {
                    type: "LineString",
                    coordinates: [
                        places['World Bank'],
                        places.Nepal
                    ],
                    properties: {
                        class:'provider',
                        type:'route',
                        volume: 104665191
                    }
                }
            ]
            
            var projection = d3.geo.equirectangular()
                .scale(170)
                .rotate([-84,0])
                .translate([width / 2 , height / 2])
                .precision(.1);
            
            var path = d3.geo.path().projection(projection);
            
            var svg = d3.select('body').append('svg')
                .attr('width',width)
                .attr('height',height)

                        
            

            
            d3.json("world-50.json", function(error, world) {
                
                var worldMap = topojson.feature(world,world.objects.land);
                worldMap.properties['class'] = 'land';
                
                paths.unshift(worldMap);
                
                svg.selectAll('path')
                    .data(paths)
                .enter().append('path')
                .attr('class',function(d) { return d.properties.class;})
                .attr('d',path)
                .attr('stroke-width',function(d) {  if (d.properties.type == 'route') return Math.max(((d.properties.volume / 104665191) * 3),0.2); return 0;})
                
                /*
                svg.insert("path", ".graticule")
                    .datum(topojson.feature(world, world.objects.land))
                    .attr("class", "land")
                   .attr("d", path);
                
                for (p in paths) {
                    svg.insert('path')
                        .datum(paths[p].path)
                        //.enter().append('path')
                        .attr('class','route')
                        .attr('d',path)
                        .attr('stroke-width',paths[p].volume)
                }*/
            
                var point = svg.append('g')
                    .attr('class','points')
                    .selectAll('g')
                    .data(d3.entries(places))
                    .enter().append('g')
                    .attr("transform", function(d) { return "translate(" + projection(d.value) + ")"; })
                    
                point.append('circle')
                    .attr('r',function(d) {console.log(Math.max(Math.sqrt((volumes[d.key].volume / volumes['Nepal'].volume)) * 10,0.2)); return Math.max(  	Math.sqrt((volumes[d.key].volume / volumes['Nepal'].volume)) * 10,0.2)})
                    .attr('class', function(d) {return volumes[d.key].type})
                    
                
                point.append('text')
                    .attr('y',0)
                    .attr('x',function(d) {
                        switch(d.key) {
                            case 'Canada':return -10; break;
                            case 'China':return -10; break;
                            case 'Finland':return 25; break;
                            case 'Germany':return -30; break;
                            case 'India':return -10; break;
                            case 'Nepal':return -20; break;
                            case 'Vietnam':return -20; break;
                            case 'Asian Development Bank':return 65; break;
                            case 'Government of Finland':return 55; break;
                            case 'Swiss Agency for Development and Cooperation':return -10; break;
                            case 'World Bank':return 35; break;
                        }
                    })
                    .attr('y',function(d) {
                        switch(d.key) {
                            case 'Canada':return 10; break;
                            case 'China':return 7; break;
                            case 'Finland':return -10; break;
                            case 'Germany':return -10; break;
                            case 'India':return 5; break;
                            case 'Nepal':return 0; break;
                            case 'Vietnam':return 5; break;
                            case 'Asian Development Bank':return 0; break;
                            case 'Government of Finland':return 5; break;
                            case 'Swiss Agency for Development and Cooperation':return 10; break;
                            case 'World Bank':return 0; break;
                        }
                    })
                    .attr('dy','.71em')
                    .text(function(d) {return d.key})
            })
            

                        
        </script>
    </body>
</html>